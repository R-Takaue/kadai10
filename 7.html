<!doctype html>
<meta charset="utf-8">
<title>7-5′ Platform Landing</title>
<canvas id="cv" width="640" height="360" style="background:#0e1528"></canvas>
<script>
const cv = document.getElementById('cv');
const ctx = cv.getContext('2d');

// ── オブジェクト ─────────────────────────
//アニメーションのための回転角度追加
const player = { x: 80, y: 300, w: 28, h: 36 ,rot: 0, rotating: false};
const floor  = { x: 0,  y: 320, w: 640, h: 40 };
const plat   = { x: 460, y: 240, w: 160, h: 16 }; // ★追加：浮遊足場

// ─ 動く足場 ─
const plat2  = { x:360, y:160, w:120, h:16, vx: 90, dir:-1, min:220, max:560 };

// ─ トラップオブジェクト ─ // ★追加
const trap   = { x:300, y:50, w:30, h:120, color:'#f65b6a' }; // 触れるとアウト

// ─ ゴールオブジェクトとゴール状態管理変数 ─ // ★追加
const goal   = { x:20, y:50, w:40, h:36, color:'#f8e05d' };
let reached=false;

// ── 物理パラメータ ────────────────────────
let vx = 0    // ★追加横方向の移動速度
let vy = 0;
const speed = 240;   // ★追加：地上での移動速度(px/s)
const jump  = 700;   // ★追加：ジャンプ初速(px/s)
const g     = 2000;  // 重力加速度(px/s^2)
let isGrounded = false;

let twiceJump = true;

// パラメータに追加
const bounce = 0.45;    // ★追加：反発係数(0〜1)
const impact = 250;     // ★追加：バウンドさせる最小落下速度

friction = 0.88         // ★２ 追加：摩擦係数

// ── 入力 ──────────────────────────────────
const keys = {};
addEventListener('keydown', e => keys[e.key] = true);   // ★追加：イベントリスナ、第2引数はアロー関数
addEventListener('keyup',   e => keys[e.key] = false);  // ★追加：イベントリスナ、第２引数はアロー関数
addEventListener('keydown', e=>{
  // 地上にいるときだけジャンプ
  if (e.code === 'Space') {
    if (isGrounded) {
      //ジャンプ1回目
       vy = -jump;
      }
      else if (twiceJump){
        //ジャンプ2回目
        vy = -jump;
        twiceJump = false;

        //アニメーション
        player.rot = 0;
        player.rotating = true;
      }
    }     // ★変更：パラメータを使用
});

// ── 衝突処理：床 ★変更、isGroundedの更新処理をupdate()に移動──────────────────────────
function collideWithFloor() {
  const bottom = player.y + player.h;
  if (bottom > floor.y) {
    player.y = floor.y - player.h; // 吸着
    if (Math.abs(vy) > impact) {      // ★追加：速度が一定以上ならば
      vy = -vy * bounce; // ★追加：軽く跳ね返る
      isGrounded = false;
    } else {
      vy = 0;
      isGrounded = true;   // 着地
      twiceJump = true;
    }
  } else {
    isGrounded = false;
  }

}

// ── 当たり判定ユーティリティ（AABB） ──────
function aabb(r1, r2) {
  return (r1.x < r2.x + r2.w && r1.x + r1.w > r2.x &&
          r1.y < r2.y + r2.h && r1.y + r1.h > r2.y);
}

// ── 衝突処理：浮遊足場（上からのみ着地） ──
function collideWithPlatform(dt) {
  // 今フレームの矩形
  const pNow = { x: player.x, y: player.y, w: player.w, h: player.h };
  if (!aabb(pNow, plat)) return; // そもそも重なっていない

  // 前フレームの“底”が足場の上面より上にあったなら「上から来た」とみなす
  const prevBottom = (player.y - vy * dt) + player.h;
  const platformTop = plat.y;

  if (prevBottom <= platformTop && vy >= 0) {
    // 上から着地
    player.y = platformTop - player.h; // 吸着
    vy = 0;
    isGrounded = true;
    twiceJump = true;
  } else {
    // 横や下から来た場合は「乗れない」簡易仕様：今回は処理しない（すり抜け）
    // 発展：横からのめり込み解除や天井衝突を入れると完成度が上がる
  }
}

// ── 移動処理：動く足場 ────────────────
function movePlatform2(dt) {
  plat2.x += plat2.vx * plat2.dir * dt;
  if (plat2.x < 50 || plat2.x + plat2.w > 590) plat2.dir *= -1;
}

// ── 衝突処理：動く足場 ────────────────
function collideWithPlatform2(dt){
  if (!aabb(player, plat2)) return;
  const prevBottom = (player.y - vy*dt) + player.h;
  if (prevBottom <= plat2.y && vy >= 0){
    // 上から着地＆足場と一緒に動く
    player.y = plat2.y - player.h;
    vy = 0;
    isGrounded = true;
    player.x += plat2.vx * plat2.dir * dt; // 乗っている間は運ばれる
  }
}

// ── 衝突処理：トラップ ────────────────// ★追加
function checkTrap() {
  if (aabb(player, trap)) {
    // 当たったら初期位置へ
    player.x = 100;
    player.y = 100;
    vy = 0;
  }
}

// ── 衝突処理：ゴール ────────────────// ★追加
function checkGoal() {
  if (aabb(player, goal)) reached = true;
}

// ── 位置更新 ─────────
function update(dt){
  // 入力 → 水平方向速度（簡略：即時切替）
  // vx = 0;                           // ★１ コメントアウトに変更
  if (keys['ArrowLeft'])  vx = -speed;
  else if (keys['ArrowRight']) vx =  speed; // ★３：else if に変更
  else if (isGrounded) vx *= friction;      // ★３ 追加

  player.x += vx * dt;
  vy += g * dt;            // 重力で速度が増える
  player.y += vy * dt;     // 位置更新

  // 衝突判定（毎フレーム isGrounded をリセットしてから判定）
  isGrounded = false;
  collideWithFloor();
  collideWithPlatform(dt);  
  collideWithPlatform2(dt);  // ★追加
  movePlatform2(dt); // ★追加
  checkTrap();    // ★追加
  checkGoal();    // ★追加

  //2段ジャンプのアニメーション
  if (player.rotating) {
  player.rot += dt * 10;
  if (player.rot >= Math.PI * 2) {
    player.rot = 0;
    player.rotating = false;
  }
}
}


// ── 描画 ──────────────────────────────────
function draw() {
  ctx.clearRect(0,0,cv.width,cv.height);

  // 床
  ctx.fillStyle = '#203060';
  ctx.fillRect(floor.x, floor.y, floor.w, floor.h);

  // 浮遊足場
  ctx.fillStyle = '#2e446e';
  ctx.fillRect(plat.x, plat.y, plat.w, plat.h);

  // ★追加：動く足場
  ctx.fillStyle='#4468cc';
  ctx.fillRect(plat2.x,plat2.y,plat2.w,plat2.h);

    // trap  ★：追加
  ctx.fillStyle=trap.color;
  ctx.fillRect(trap.x, trap.y, trap.w, trap.h);

    // ゴールオブジェクト　★追加
  ctx.fillStyle = goal.color;
  ctx.fillRect(goal.x, goal.y, goal.w, goal.h);

  // ゴールの状態管理変数を使ってゴール状態を表示する　★追加
  if (reached) {
    ctx.fillStyle = '#fff';
    ctx.font = '28px sans-serif';
    ctx.fillText('Goal!', 270, 180);
  }

  // プレイヤー（地上:水色／空中:黄）
  ctx.save();
  ctx.translate(player.x + player.w/2, player.y + player.h/2);
  ctx.rotate(player.rot);
  ctx.fillStyle = isGrounded ? '#7ef5e1' : '#ffd166';
  ctx.fillRect(-player.w/2, -player.h/2, player.w, player.h);
  ctx.restore();

  // HUD
  ctx.fillStyle = '#cbd5e1';
  ctx.font = '12px ui-monospace,monospace';
  ctx.fillText(`vy=${vy.toFixed(1)} grounded=${isGrounded}`, 8, 16);
}

// ── ループ ─────────────────────────────────
let last = performance.now();
function loop(now) {
  const dt = (now - last) / 1000; last = now;

  update(dt);
  draw();
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

</script>